<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Deck</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #1a1410;
    --surface: #242018;
    --card-bg: #f5f0e8;
    --card-border: #c8b89a;
    --ink: #2c2416;
    --gold: #c9a84c;
    --gold-light: #e8d08a;
    --muted: #6b5d4a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--card-bg);
    font-family: 'Crimson Text', Georgia, serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px;
    background-image:
      radial-gradient(ellipse at 20% 50%, rgba(201,168,76,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(201,168,76,0.03) 0%, transparent 50%);
  }

  h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2rem, 5vw, 3.2rem);
    font-weight: 700;
    letter-spacing: 0.08em;
    color: var(--gold);
    text-align: center;
    margin-bottom: 4px;
  }

  .subtitle {
    font-style: italic;
    color: var(--muted);
    font-size: 1rem;
    margin-bottom: 32px;
    text-align: center;
  }

  /* ── SHARED SCREEN UTILS ──────────────────────────────────────────────── */
  .screen {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
  }

  .screen.active { display: flex; }

  .panel {
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 12px;
    padding: 28px;
    width: 100%;
    max-width: 420px;
  }

  .panel h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    color: var(--gold-light);
    margin-bottom: 20px;
    text-align: center;
  }

  .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }

  .field label {
    font-size: 0.8rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  input[type="text"], input[type="password"] {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 6px;
    color: var(--card-bg);
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  input[type="text"]:focus, input[type="password"]:focus { border-color: var(--gold); }

  .btn-primary {
    background: linear-gradient(135deg, #c9a84c, #a8853a);
    color: #1a1410;
    border: none;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 16px rgba(201,168,76,0.2);
    width: 100%;
    margin-top: 4px;
  }

  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(201,168,76,0.35); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: default; transform: none; box-shadow: none; }

  .btn-secondary {
    background: none;
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--gold-light);
    font-family: 'Crimson Text', serif;
    font-size: 0.95rem;
    padding: 10px 24px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-top: 4px;
  }

  .btn-secondary:hover { border-color: var(--gold); background: rgba(201,168,76,0.06); }

  .btn-text {
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'Crimson Text', serif;
    font-size: 0.9rem;
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 3px;
    padding: 4px;
    transition: color 0.2s;
  }

  .btn-text:hover { color: var(--gold-light); }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
    color: var(--muted);
    font-size: 0.85rem;
  }

  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(201,168,76,0.15);
  }

  .error-msg {
    color: #e07070;
    font-size: 0.88rem;
    font-style: italic;
    text-align: center;
    min-height: 1.1em;
    margin-top: 6px;
  }

  .success-msg {
    color: #7ed4a0;
    font-size: 0.88rem;
    font-style: italic;
    text-align: center;
    min-height: 1.1em;
    margin-top: 6px;
  }

  /* ── SPINNER ──────────────────────────────────────────────────────────── */
  .spinner {
    width: 36px;
    height: 36px;
    border: 3px solid rgba(201,168,76,0.2);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { color: var(--muted); font-style: italic; text-align: center; }

  /* ── USER BAR — shown at top when logged in ───────────────────────────── */
  #user-bar {
    display: none;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 900px;
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.15);
    border-radius: 8px;
    padding: 8px 16px;
    margin-bottom: 8px;
    font-size: 0.88rem;
  }

  #user-bar.visible { display: flex; }

  .user-bar-name {
    color: var(--gold-light);
    font-family: 'Playfair Display', serif;
  }

  .user-bar-tag {
    color: var(--muted);
    font-size: 0.8rem;
    margin-left: 6px;
  }

  .btn-signout {
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'Crimson Text', serif;
    font-size: 0.85rem;
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 2px;
    padding: 2px 4px;
    transition: color 0.2s;
  }

  .btn-signout:hover { color: #e07070; }

  /* ── SETUP SCREEN ─────────────────────────────────────────────────────── */
  .player-entry {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    align-items: center;
  }

  .player-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .btn-add-player {
    background: none;
    border: 1px dashed rgba(201,168,76,0.3);
    color: var(--muted);
    font-family: 'Crimson Text', serif;
    font-size: 0.95rem;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
    margin-top: 4px;
  }

  .btn-add-player:hover { border-color: var(--gold); color: var(--gold-light); }

  /* ── GAME SCREEN ──────────────────────────────────────────────────────── */
  #game-screen { display: none; width: 100%; max-width: 900px; }

  .game-layout {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 680px) {
    .game-layout { grid-template-columns: 1fr; }
    .center-col { order: -1; }
  }

  .turn-banner {
    text-align: center;
    margin-bottom: 24px;
    padding: 14px;
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 10px;
  }

  .turn-label {
    font-size: 0.85rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .turn-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 700;
    transition: color 0.4s;
  }

  .center-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .deck-area {
    position: relative;
    width: 140px;
    height: 200px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .deck-shadow {
    position: absolute;
    width: 130px;
    height: 190px;
    background: rgba(0,0,0,0.4);
    border-radius: 10px;
    top: 6px;
    left: 6px;
  }

  .deck-card {
    position: absolute;
    width: 130px;
    height: 190px;
    background: linear-gradient(135deg, #2a3a5c, #1e2d4a);
    border: 2px solid rgba(201,168,76,0.4);
    border-radius: 10px;
    top: 0; left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s;
  }

  .deck-area:hover .deck-card { transform: translateY(-4px); }
  .deck-area.empty .deck-card { opacity: 0.25; cursor: default; }
  .deck-area.empty:hover .deck-card { transform: none; }

  .deck-pattern {
    width: 90px;
    height: 140px;
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .deck-count {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    color: var(--gold);
    font-weight: 700;
  }

  .deck-label {
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .btn-draw {
    background: linear-gradient(135deg, #c9a84c, #a8853a);
    color: #1a1410;
    border: none;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    padding: 10px 24px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-draw:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(201,168,76,0.3); }
  .btn-draw:disabled { opacity: 0.35; cursor: default; transform: none; box-shadow: none; }

  .btn-reshuffle {
    background: none;
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--gold-light);
    font-family: 'Crimson Text', serif;
    font-size: 0.95rem;
    padding: 8px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-reshuffle:hover { border-color: var(--gold); background: rgba(201,168,76,0.08); }

  .drawn-card-area {
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    width: 100%;
  }

  .drawn-card {
    background: var(--card-bg);
    color: var(--ink);
    border-radius: 10px;
    padding: 18px 20px;
    width: 130px;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    line-height: 1.4;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    border: 1px solid var(--card-border);
    animation: cardFlip 0.35s ease-out;
    position: relative;
  }

  .drawn-card::before {
    content: '';
    position: absolute;
    inset: 5px;
    border: 1px solid rgba(44,36,22,0.15);
    border-radius: 6px;
    pointer-events: none;
  }

  @keyframes cardFlip {
    from { transform: rotateY(90deg) scale(0.8); opacity: 0; }
    to { transform: rotateY(0deg) scale(1); opacity: 1; }
  }

  .drawn-by { font-size: 0.8rem; color: var(--muted); font-style: italic; }

  .player-panel {
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.15);
    border-radius: 10px;
    padding: 16px;
    min-height: 200px;
  }

  .player-panel h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(201,168,76,0.15);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .player-dot-lg { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  .hand-cards { display: flex; flex-direction: column; gap: 6px; }

  .hand-card {
    background: rgba(245,240,232,0.06);
    border: 1px solid rgba(200,184,154,0.15);
    border-radius: 6px;
    padding: 7px 10px;
    font-size: 0.88rem;
    color: rgba(245,240,232,0.75);
    font-style: italic;
    line-height: 1.3;
  }

  .hand-empty { color: var(--muted); font-style: italic; font-size: 0.85rem; }

  .all-players {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
  }

  .status-bar {
    text-align: center;
    color: var(--muted);
    font-style: italic;
    font-size: 0.9rem;
    margin-top: 8px;
    min-height: 1.2em;
  }

  .highlight { color: var(--gold-light); }
  .btn-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

  /* ── SYNC INDICATOR ───────────────────────────────────────────────────── */
  .sync-indicator {
    position: fixed;
    bottom: 16px;
    right: 16px;
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 0.8rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }

  .sync-indicator.visible { opacity: 1; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gold); }
  .sync-dot.saving { animation: pulse 0.6s ease-in-out infinite alternate; }
  .sync-dot.saved { background: #7ed4a0; }
  .sync-dot.error { background: #e07070; }
  @keyframes pulse { to { opacity: 0.3; } }

  /* ── CONFIRM OVERLAY ──────────────────────────────────────────────────── */
  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(3px);
  }

  .confirm-box {
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 12px;
    padding: 32px;
    text-align: center;
    max-width: 320px;
    width: 90%;
  }

  .confirm-box h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    color: var(--gold-light);
    margin-bottom: 10px;
  }

  .confirm-box p { color: var(--muted); margin-bottom: 24px; font-size: 0.95rem; }
  .confirm-btn-row { display: flex; gap: 12px; justify-content: center; }

  .btn-danger {
    background: #8b3a3a;
    color: #f5e8e8;
    border: none;
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    padding: 10px 22px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-danger:hover { background: #a84444; }

  .btn-ghost {
    background: none;
    border: 1px solid rgba(255,255,255,0.15);
    color: var(--muted);
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    padding: 10px 22px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-ghost:hover { border-color: rgba(255,255,255,0.3); color: var(--card-bg); }

  /* ── GUEST NOTICE ─────────────────────────────────────────────────────── */
  .guest-notice {
    background: rgba(201,168,76,0.06);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.85rem;
    color: var(--muted);
    text-align: center;
    margin-bottom: 8px;
    width: 100%;
    max-width: 900px;
  }

  .guest-notice span { color: var(--gold-light); cursor: pointer; text-decoration: underline; text-underline-offset: 2px; }
</style>
</head>
<body>

<h1>The Deck</h1>
<p class="subtitle">A game of drawing & doing</p>

<!-- USER BAR — shown when logged in -->
<div id="user-bar">
  <div>
    <span class="user-bar-name" id="user-bar-name">—</span>
    <span class="user-bar-tag">signed in</span>
  </div>
  <button class="btn-signout" onclick="signOut()">Sign out</button>
</div>

<!-- GUEST NOTICE — shown when playing as guest -->
<div class="guest-notice" id="guest-notice" style="display:none">
  Playing as guest — progress won't be saved between sessions.
  <span onclick="showScreen('login-screen')">Sign in to save your games.</span>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════
     LOADING SCREEN
════════════════════════════════════════════════════════════════════════ -->
<div class="screen active" id="loading-screen" style="margin-top:60px">
  <div class="spinner"></div>
  <p class="loading-text">Loading…</p>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════
     LOGIN SCREEN
     Username + password. Auto-registers if username is new.
════════════════════════════════════════════════════════════════════════ -->
<div class="screen" id="login-screen">
  <div class="panel">
    <h2>Welcome Back</h2>

    <div class="field">
      <label>Username</label>
      <input type="text" id="login-username" placeholder="your username" autocomplete="username" autocapitalize="none">
    </div>

    <div class="field">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="your password" autocomplete="current-password">
    </div>

    <p class="error-msg" id="login-error"></p>

    <button class="btn-primary" id="btn-login" onclick="handleLogin()">Sign In</button>

    <div class="divider">or</div>

    <button class="btn-secondary" onclick="showScreen('register-screen')">Create an Account</button>
    <button class="btn-secondary" onclick="playAsGuest()" style="margin-top:8px">Play as Guest</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════
     REGISTER SCREEN
════════════════════════════════════════════════════════════════════════ -->
<div class="screen" id="register-screen">
  <div class="panel">
    <h2>Create Account</h2>

    <div class="field">
      <label>Choose a Username</label>
      <input type="text" id="reg-username" placeholder="pick a name" autocomplete="username" autocapitalize="none">
    </div>

    <div class="field">
      <label>Password</label>
      <input type="password" id="reg-password" placeholder="at least 6 characters" autocomplete="new-password">
    </div>

    <div class="field">
      <label>Confirm Password</label>
      <input type="password" id="reg-confirm" placeholder="repeat password" autocomplete="new-password">
    </div>

    <p class="error-msg" id="reg-error"></p>
    <p class="success-msg" id="reg-success"></p>

    <button class="btn-primary" id="btn-register" onclick="handleRegister()">Create Account</button>

    <div class="divider">already have one?</div>

    <button class="btn-secondary" onclick="showScreen('login-screen')">Sign In Instead</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════
     SETUP SCREEN — who's playing this game?
════════════════════════════════════════════════════════════════════════ -->
<div class="screen" id="setup-screen">
  <div class="panel">
    <h2>Who's Playing?</h2>
    <div id="player-list">
      <div class="player-entry">
        <div class="player-dot" style="background:#7eb8d4"></div>
        <input type="text" placeholder="Player 1 name">
      </div>
      <div class="player-entry">
        <div class="player-dot" style="background:#d47e7e"></div>
        <input type="text" placeholder="Player 2 name">
      </div>
    </div>
    <button class="btn-add-player" id="btn-add-player" onclick="addPlayer()">+ Add another player</button>
  </div>
  <p class="error-msg" id="setup-error"></p>
  <button class="btn-primary" style="max-width:420px" onclick="startGame()">Deal the Deck</button>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════
     GAME SCREEN
════════════════════════════════════════════════════════════════════════ -->
<div id="game-screen">
  <div class="turn-banner">
    <div class="turn-label">Current Turn</div>
    <div class="turn-name" id="turn-name">—</div>
  </div>

  <div class="game-layout">
    <div id="left-panel" class="player-panel">
      <h3><span class="player-dot-lg" id="left-dot"></span><span id="left-name">Player</span></h3>
      <div class="hand-cards" id="left-hand"></div>
    </div>

    <div class="center-col">
      <div class="deck-area" id="deck-area" onclick="drawCard()">
        <div class="deck-shadow"></div>
        <div class="deck-card">
          <div class="deck-pattern">
            <span class="deck-count" id="deck-count">19</span>
          </div>
        </div>
      </div>
      <div class="deck-label">cards remaining</div>
      <div class="drawn-card-area" id="drawn-card-area">
        <div class="status-bar">Click the deck to draw</div>
      </div>
      <div class="btn-row">
        <button class="btn-draw" id="btn-draw" onclick="drawCard()">Draw Card</button>
        <button class="btn-reshuffle" onclick="confirmReshuffle()">↺ Reshuffle</button>
      </div>
    </div>

    <div id="right-panel" class="player-panel">
      <h3><span class="player-dot-lg" id="right-dot"></span><span id="right-name">Player</span></h3>
      <div class="hand-cards" id="right-hand"></div>
    </div>
  </div>

  <div class="all-players" id="extra-players"></div>
</div>

<!-- Confirm reshuffle overlay -->
<div class="confirm-overlay" id="confirm-overlay" style="display:none">
  <div class="confirm-box">
    <h3>Reshuffle the Deck?</h3>
    <p>All cards will be returned and the deck shuffled. Everyone's hand will be cleared.</p>
    <div class="confirm-btn-row">
      <button class="btn-ghost" onclick="closeConfirm()">Cancel</button>
      <button class="btn-danger" onclick="reshuffle()">Yes, Reshuffle</button>
    </div>
  </div>
</div>

<!-- Sync indicator -->
<div class="sync-indicator" id="sync-indicator">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-text">Saving…</span>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// SUPABASE SETUP
// ═══════════════════════════════════════════════════════════════════════════
const SUPABASE_URL  = 'https://ffztxyeevdqlhvxzcopn.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmenR4eWVldmRxbGh2eHpjb3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNzgxMTMsImV4cCI6MjA4Nzg1NDExM30.EdA8cwETE00YFENj-CN93ScKMFN4yfNNG63BentHiQ4';

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON);

// ═══════════════════════════════════════════════════════════════════════════
// CARD DATA
// ═══════════════════════════════════════════════════════════════════════════
const CARD_TEXTS = [
  "Nothing","No target","Miss","Relocate","Nothing there",
  "Grenade: relocate in 2 or explode","Bandage",
  "High Ground: Spotting 8+(D12)","Counter Snipe: 4+(D6)",
  "Snipers relocate","Missed shot","Hit","Hit the target",
  "No thing","Not a target","Found him: Body","Found him: Head",
  "Decoy","Decoy deployed",
];

const COLORS = ['#7eb8d4','#d47e7e','#7ed4a0','#d4c07e','#c47ed4','#d4a07e'];

// ═══════════════════════════════════════════════════════════════════════════
// APP STATE
// ═══════════════════════════════════════════════════════════════════════════
let currentUser    = null;  // Supabase auth user object (null if guest)
let currentProfile = null;  // Row from our profiles table { id, username }
let isGuest        = false; // True when playing without an account

let players            = [];
let deck               = [];
let hands              = {};
let currentPlayerIndex = 0;
let lastDrawn          = null;
let currentGameId      = null;
let isSaving           = false;

// ═══════════════════════════════════════════════════════════════════════════
// STARTUP
// ═══════════════════════════════════════════════════════════════════════════
async function init() {
  // Check if Supabase already has a session (user previously logged in)
  const { data: { session } } = await db.auth.getSession();

  if (session) {
    // Restore the logged-in user
    currentUser = session.user;
    await loadProfile(currentUser.id);
    showUserBar();

    // Check for a saved game
    const savedId = localStorage.getItem('deck_game_id_' + currentUser.id);
    if (savedId) {
      const loaded = await loadGame(savedId);
      if (loaded) return;
    }
    showScreen('setup-screen');

  } else {
    // No session — show login
    showScreen('login-screen');
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// AUTH — LOGIN
// ═══════════════════════════════════════════════════════════════════════════
async function handleLogin() {
  const username = document.getElementById('login-username').value.trim().toLowerCase();
  const password = document.getElementById('login-password').value;
  const errEl    = document.getElementById('login-error');
  const btn      = document.getElementById('btn-login');

  errEl.textContent = '';

  if (!username) { errEl.textContent = 'Please enter your username.'; return; }
  if (!password) { errEl.textContent = 'Please enter your password.'; return; }

  btn.disabled = true;
  btn.textContent = 'Signing in…';

  // We store users as username@thedeck.game internally
  const fakeEmail = `${username}@thedeck.game`;

  const { data, error } = await db.auth.signInWithPassword({
    email: fakeEmail,
    password,
  });

  btn.disabled = false;
  btn.textContent = 'Sign In';

  if (error) {
    errEl.textContent = 'Incorrect username or password.';
    return;
  }

  currentUser = data.user;
  await loadProfile(currentUser.id);
  showUserBar();

  // Check for a saved game for this user
  const savedId = localStorage.getItem('deck_game_id_' + currentUser.id);
  if (savedId) {
    const loaded = await loadGame(savedId);
    if (loaded) return;
  }

  showScreen('setup-screen');
}

// ═══════════════════════════════════════════════════════════════════════════
// AUTH — REGISTER
// ═══════════════════════════════════════════════════════════════════════════
async function handleRegister() {
  const username = document.getElementById('reg-username').value.trim().toLowerCase();
  const password = document.getElementById('reg-password').value;
  const confirm  = document.getElementById('reg-confirm').value;
  const errEl    = document.getElementById('reg-error');
  const okEl     = document.getElementById('reg-success');
  const btn      = document.getElementById('btn-register');

  errEl.textContent = '';
  okEl.textContent  = '';

  // Validate
  if (!username)              { errEl.textContent = 'Please choose a username.'; return; }
  if (username.length < 3)    { errEl.textContent = 'Username must be at least 3 characters.'; return; }
  if (/\s/.test(username))    { errEl.textContent = 'Username cannot contain spaces.'; return; }
  if (!password)              { errEl.textContent = 'Please choose a password.'; return; }
  if (password.length < 6)    { errEl.textContent = 'Password must be at least 6 characters.'; return; }
  if (password !== confirm)   { errEl.textContent = 'Passwords do not match.'; return; }

  btn.disabled = true;
  btn.textContent = 'Creating account…';

  const fakeEmail = `${username}@thedeck.game`;

  // Create the auth account
  const { data, error } = await db.auth.signUp({
    email: fakeEmail,
    password,
  });

  if (error) {
    btn.disabled = false;
    btn.textContent = 'Create Account';
    // Common case: username already taken
    if (error.message.includes('already registered')) {
      errEl.textContent = 'That username is already taken. Please choose another.';
    } else {
      errEl.textContent = error.message;
    }
    return;
  }

  // Create a row in our profiles table
  const { error: profileError } = await db.from('profiles').insert({
    id: data.user.id,
    username: username,
  });

  btn.disabled = false;
  btn.textContent = 'Create Account';

  if (profileError) {
    // Most likely the username is taken in profiles even if auth succeeded
    errEl.textContent = 'That username is already taken. Please choose another.';
    // Clean up the orphaned auth user if possible
    await db.auth.signOut();
    return;
  }

  // Success — auto sign them in
  currentUser = data.user;
  currentProfile = { id: data.user.id, username };
  showUserBar();
  showScreen('setup-screen');
}

// ═══════════════════════════════════════════════════════════════════════════
// AUTH — GUEST
// ═══════════════════════════════════════════════════════════════════════════
function playAsGuest() {
  isGuest = true;
  currentUser = null;
  currentProfile = null;
  document.getElementById('guest-notice').style.display = 'block';
  showScreen('setup-screen');
}

// ═══════════════════════════════════════════════════════════════════════════
// AUTH — SIGN OUT
// ═══════════════════════════════════════════════════════════════════════════
async function signOut() {
  await db.auth.signOut();
  currentUser    = null;
  currentProfile = null;
  isGuest        = false;
  currentGameId  = null;

  document.getElementById('user-bar').classList.remove('visible');
  document.getElementById('guest-notice').style.display = 'none';
  document.getElementById('game-screen').style.display = 'none';

  // Clear player list back to default
  resetPlayerList();
  showScreen('login-screen');
}

// ═══════════════════════════════════════════════════════════════════════════
// PROFILE
// ═══════════════════════════════════════════════════════════════════════════
async function loadProfile(userId) {
  const { data } = await db
    .from('profiles')
    .select('*')
    .eq('id', userId)
    .single();

  if (data) currentProfile = data;
}

function showUserBar() {
  const bar = document.getElementById('user-bar');
  bar.classList.add('visible');
  document.getElementById('user-bar-name').textContent =
    currentProfile ? currentProfile.username : 'Player';
}

// ═══════════════════════════════════════════════════════════════════════════
// SETUP
// ═══════════════════════════════════════════════════════════════════════════
function addPlayer() {
  const list  = document.getElementById('player-list');
  const count = list.children.length + 1;
  if (count > 6) return;
  const color = COLORS[count - 1] || '#aaa';
  const div   = document.createElement('div');
  div.className = 'player-entry';
  div.innerHTML = `
    <div class="player-dot" style="background:${color}"></div>
    <input type="text" placeholder="Player ${count} name">
  `;
  list.appendChild(div);
  if (count >= 6) document.getElementById('btn-add-player').style.display = 'none';
}

function resetPlayerList() {
  const list = document.getElementById('player-list');
  list.innerHTML = `
    <div class="player-entry">
      <div class="player-dot" style="background:#7eb8d4"></div>
      <input type="text" placeholder="Player 1 name">
    </div>
    <div class="player-entry">
      <div class="player-dot" style="background:#d47e7e"></div>
      <input type="text" placeholder="Player 2 name">
    </div>
  `;
  document.getElementById('btn-add-player').style.display = 'block';
}

async function startGame() {
  const inputs = document.querySelectorAll('#player-list input');
  players = [];
  inputs.forEach((inp, i) => {
    const name = inp.value.trim() || `Player ${i + 1}`;
    players.push({ name, color: COLORS[i] });
  });

  hands              = {};
  players.forEach(p => hands[p.name] = []);
  currentPlayerIndex = 0;
  lastDrawn          = null;
  deck               = shuffle([...CARD_TEXTS]);

  const btn = document.querySelector('#setup-screen .btn-primary');
  btn.disabled    = true;
  btn.textContent = 'Starting…';

  let saved = true;
  if (!isGuest) {
    saved = await saveNewGame();
  } else {
    // Guest — just store in sessionStorage
    sessionStorage.setItem('deck_guest_state', JSON.stringify(buildGameState()));
  }

  btn.disabled    = false;
  btn.textContent = 'Deal the Deck';

  if (!saved) {
    document.getElementById('setup-error').textContent = 'Could not save to database. Check your connection.';
    return;
  }

  document.getElementById('setup-error').textContent = '';
  showScreen(null); // hide all screens
  document.getElementById('game-screen').style.display = 'block';
  renderPlayerPanels();
  updateUI();
}

// ═══════════════════════════════════════════════════════════════════════════
// GAME LOGIC
// ═══════════════════════════════════════════════════════════════════════════
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

async function drawCard() {
  if (deck.length === 0 || isSaving) return;

  const card   = deck.pop();
  const player = players[currentPlayerIndex];
  hands[player.name].push(card);
  lastDrawn          = { card, playerName: player.name };
  currentPlayerIndex = (currentPlayerIndex + 1) % players.length;

  updateUI();
  await persistState('draw', card);
}

async function reshuffle() {
  closeConfirm();
  deck               = shuffle([...CARD_TEXTS]);
  players.forEach(p => hands[p.name] = []);
  lastDrawn          = null;
  currentPlayerIndex = 0;

  updateUI();
  renderHandsOnly();
  await persistState('reshuffle', null);
}

// Single function that handles saving for both logged-in and guest players
async function persistState(eventType, cardText) {
  if (isGuest) {
    sessionStorage.setItem('deck_guest_state', JSON.stringify(buildGameState()));
    return;
  }
  await saveGameState();
  await logEvent(eventType, cardText);
}

// ═══════════════════════════════════════════════════════════════════════════
// SUPABASE — DATABASE OPERATIONS
// ═══════════════════════════════════════════════════════════════════════════
async function saveNewGame() {
  try {
    showSyncing('Saving…');
    const { data, error } = await db
      .from('games')
      .insert({
        join_code:             generateJoinCode(),
        deck:                  buildGameState(),
        current_player_index:  currentPlayerIndex,
        status:                'active',
      })
      .select()
      .single();

    if (error) { console.error(error); showSyncError(); return false; }

    currentGameId = data.id;
    // Store against the user ID so different users don't collide
    localStorage.setItem('deck_game_id_' + currentUser.id, currentGameId);
    showSynced();
    return true;

  } catch (err) { console.error(err); showSyncError(); return false; }
}

async function saveGameState() {
  if (!currentGameId || isSaving) return;
  try {
    isSaving = true;
    showSyncing('Saving…');
    const { error } = await db
      .from('games')
      .update({
        deck:                  buildGameState(),
        current_player_index:  currentPlayerIndex,
      })
      .eq('id', currentGameId);

    if (error) { console.error(error); showSyncError(); }
    else        { showSynced(); }
  } catch (err) { console.error(err); showSyncError(); }
  finally       { isSaving = false; }
}

async function loadGame(gameId) {
  try {
    const { data, error } = await db
      .from('games')
      .select('*')
      .eq('id', gameId)
      .eq('status', 'active')
      .single();

    if (error || !data) {
      localStorage.removeItem('deck_game_id_' + currentUser.id);
      return false;
    }

    const state        = data.deck;
    players            = state.players;
    deck               = state.deck;
    hands              = state.hands;
    lastDrawn          = state.lastDrawn;
    currentPlayerIndex = data.current_player_index;
    currentGameId      = data.id;

    showScreen(null);
    document.getElementById('game-screen').style.display = 'block';
    renderPlayerPanels();
    updateUI();
    return true;

  } catch (err) {
    console.error(err);
    localStorage.removeItem('deck_game_id_' + currentUser?.id);
    return false;
  }
}

async function logEvent(eventType, cardText) {
  if (!currentGameId) return;
  try {
    await db.from('game_events').insert({
      game_id:    currentGameId,
      profile_id: currentUser?.id || null,
      event_type: eventType,
      card_text:  cardText,
    });
  } catch (err) { console.warn('Event log failed:', err); }
}

// ═══════════════════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════════════════
function buildGameState() {
  return { players, deck, hands, lastDrawn };
}

function generateJoinCode() {
  const words = ['WOLF','HAWK','VIPER','ECHO','GHOST','RAVEN','COBRA','LYNX'];
  return `${words[Math.floor(Math.random()*words.length)]}-${Math.floor(Math.random()*9)+1}`;
}

// ═══════════════════════════════════════════════════════════════════════════
// SYNC INDICATOR
// ═══════════════════════════════════════════════════════════════════════════
let syncTimer = null;

function showSyncing(text) {
  clearTimeout(syncTimer);
  const i = document.getElementById('sync-indicator');
  document.getElementById('sync-dot').className  = 'sync-dot saving';
  document.getElementById('sync-text').textContent = text;
  i.classList.add('visible');
}

function showSynced() {
  const i = document.getElementById('sync-indicator');
  document.getElementById('sync-dot').className  = 'sync-dot saved';
  document.getElementById('sync-text').textContent = 'Saved';
  syncTimer = setTimeout(() => i.classList.remove('visible'), 2000);
}

function showSyncError() {
  const i = document.getElementById('sync-indicator');
  document.getElementById('sync-dot').className  = 'sync-dot error';
  document.getElementById('sync-text').textContent = 'Save failed';
  syncTimer = setTimeout(() => i.classList.remove('visible'), 3000);
}

// ═══════════════════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════════════════
function renderPlayerPanels() {
  document.getElementById('left-dot').style.background  = players[0].color;
  document.getElementById('left-name').textContent       = players[0].name;
  const right = players[1] || players[0];
  document.getElementById('right-dot').style.background = right.color;
  document.getElementById('right-name').textContent      = right.name;

  const extra = document.getElementById('extra-players');
  extra.innerHTML = '';
  players.slice(2).forEach((p, i) => {
    const panel = document.createElement('div');
    panel.className = 'player-panel';
    panel.innerHTML = `
      <h3><span class="player-dot-lg" style="background:${p.color}"></span>${p.name}</h3>
      <div class="hand-cards" id="extra-hand-${i}"></div>
    `;
    extra.appendChild(panel);
  });
}

function renderHandsOnly() {
  renderHand('left-hand', players[0].name);
  if (players[1]) renderHand('right-hand', players[1].name);
  players.slice(2).forEach((p, i) => renderHand(`extra-hand-${i}`, p.name));
}

function renderHand(containerId, playerName) {
  const el    = document.getElementById(containerId);
  if (!el)    return;
  const cards = hands[playerName] || [];
  el.innerHTML = cards.length === 0
    ? '<div class="hand-empty">No cards yet</div>'
    : cards.map(c => `<div class="hand-card">${c}</div>`).join('');
}

function updateUI() {
  const remaining = deck.length;
  document.getElementById('deck-count').textContent      = remaining;
  document.getElementById('deck-area').classList.toggle('empty', remaining === 0);
  document.getElementById('btn-draw').disabled           = remaining === 0;

  const current = players[currentPlayerIndex];
  const turnEl  = document.getElementById('turn-name');
  turnEl.textContent  = current.name;
  turnEl.style.color  = current.color;

  const drawnArea = document.getElementById('drawn-card-area');
  if (lastDrawn) {
    drawnArea.innerHTML = `
      <div class="drawn-card">${lastDrawn.card}</div>
      <div class="drawn-by">Drawn by ${lastDrawn.playerName}</div>
    `;
  } else if (remaining === 0) {
    drawnArea.innerHTML = `<div class="status-bar"><span class="highlight">Deck is empty — reshuffle to play again!</span></div>`;
  } else {
    drawnArea.innerHTML = `<div class="status-bar">Click the deck to draw</div>`;
  }

  renderHandsOnly();
}

function confirmReshuffle() { document.getElementById('confirm-overlay').style.display = 'flex'; }
function closeConfirm()     { document.getElementById('confirm-overlay').style.display = 'none'; }

document.getElementById('confirm-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});

// ═══════════════════════════════════════════════════════════════════════════
// SCREEN MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════
function showScreen(id) {
  // Hide all screens
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('game-screen').style.display = 'none';
  if (id) {
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
  }
}

// Allow pressing Enter to submit login/register forms
document.getElementById('login-password').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});
document.getElementById('reg-confirm').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleRegister();
});

// ═══════════════════════════════════════════════════════════════════════════
// START
// ═══════════════════════════════════════════════════════════════════════════
init();
</script>
</body>
</html>
