<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Deck</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">

<!-- ═══════════════════════════════════════════════════════════════════════════
     SUPABASE CLIENT LIBRARY
     This single script tag gives us all Supabase functionality.
     Players do NOT need to install anything — this loads automatically.
════════════════════════════════════════════════════════════════════════════ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --bg: #1a1410;
    --surface: #242018;
    --card-bg: #f5f0e8;
    --card-border: #c8b89a;
    --ink: #2c2416;
    --gold: #c9a84c;
    --gold-light: #e8d08a;
    --muted: #6b5d4a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--card-bg);
    font-family: 'Crimson Text', Georgia, serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px;
    background-image: 
      radial-gradient(ellipse at 20% 50%, rgba(201,168,76,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(201,168,76,0.03) 0%, transparent 50%);
  }

  h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: clamp(2rem, 5vw, 3.2rem);
    font-weight: 700;
    letter-spacing: 0.08em;
    color: var(--gold);
    text-align: center;
    margin-bottom: 4px;
  }

  .subtitle {
    font-style: italic;
    color: var(--muted);
    font-size: 1rem;
    margin-bottom: 32px;
    text-align: center;
  }

  /* ── LOADING SCREEN ───────────────────────────────────────────────────── */
  #loading-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-top: 60px;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(201,168,76,0.2);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    color: var(--muted);
    font-style: italic;
  }

  /* ── SETUP SCREEN ─────────────────────────────────────────────────────── */
  #setup-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
    max-width: 480px;
  }

  .setup-card {
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 12px;
    padding: 28px;
    width: 100%;
  }

  .setup-card h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    color: var(--gold-light);
    margin-bottom: 16px;
  }

  .player-entry {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    align-items: center;
  }

  .player-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  input[type="text"], input[type="password"] {
    flex: 1;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 6px;
    color: var(--card-bg);
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    padding: 8px 12px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  input[type="text"]:focus, input[type="password"]:focus {
    border-color: var(--gold);
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 10px;
  }

  .input-label {
    font-size: 0.85rem;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .btn-add-player {
    background: none;
    border: 1px dashed rgba(201,168,76,0.3);
    color: var(--muted);
    font-family: 'Crimson Text', serif;
    font-size: 0.95rem;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
    margin-top: 4px;
  }

  .btn-add-player:hover { border-color: var(--gold); color: var(--gold-light); }

  .btn-primary {
    background: linear-gradient(135deg, #c9a84c, #a8853a);
    color: #1a1410;
    border: none;
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    padding: 14px 36px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 16px rgba(201,168,76,0.2);
    width: 100%;
  }

  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(201,168,76,0.35); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: default; transform: none; }

  .error-msg {
    color: #e07070;
    font-size: 0.9rem;
    font-style: italic;
    text-align: center;
    min-height: 1.2em;
  }

  /* ── GAME SCREEN ──────────────────────────────────────────────────────── */
  #game-screen { display: none; width: 100%; max-width: 900px; }

  .game-layout {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 680px) {
    .game-layout { grid-template-columns: 1fr; }
    .center-col { order: -1; }
  }

  .turn-banner {
    text-align: center;
    margin-bottom: 24px;
    padding: 14px;
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 10px;
  }

  .turn-label {
    font-size: 0.85rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .turn-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 700;
    transition: color 0.4s;
  }

  .center-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .deck-area {
    position: relative;
    width: 140px;
    height: 200px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .deck-shadow {
    position: absolute;
    width: 130px;
    height: 190px;
    background: rgba(0,0,0,0.4);
    border-radius: 10px;
    top: 6px;
    left: 6px;
  }

  .deck-card {
    position: absolute;
    width: 130px;
    height: 190px;
    background: linear-gradient(135deg, #2a3a5c, #1e2d4a);
    border: 2px solid rgba(201,168,76,0.4);
    border-radius: 10px;
    top: 0; left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s;
  }

  .deck-area:hover .deck-card { transform: translateY(-4px); }
  .deck-area.empty .deck-card { opacity: 0.25; cursor: default; }
  .deck-area.empty:hover .deck-card { transform: none; }

  .deck-pattern {
    width: 90px;
    height: 140px;
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .deck-count {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    color: var(--gold);
    font-weight: 700;
  }

  .deck-label {
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .btn-draw {
    background: linear-gradient(135deg, #c9a84c, #a8853a);
    color: #1a1410;
    border: none;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    padding: 10px 24px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-draw:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(201,168,76,0.3); }
  .btn-draw:disabled { opacity: 0.35; cursor: default; transform: none; box-shadow: none; }

  .btn-reshuffle {
    background: none;
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--gold-light);
    font-family: 'Crimson Text', serif;
    font-size: 0.95rem;
    padding: 8px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-reshuffle:hover { border-color: var(--gold); background: rgba(201,168,76,0.08); }

  .drawn-card-area {
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    width: 100%;
  }

  .drawn-card {
    background: var(--card-bg);
    color: var(--ink);
    border-radius: 10px;
    padding: 18px 20px;
    width: 130px;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    line-height: 1.4;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    border: 1px solid var(--card-border);
    animation: cardFlip 0.35s ease-out;
    position: relative;
  }

  .drawn-card::before {
    content: '';
    position: absolute;
    inset: 5px;
    border: 1px solid rgba(44,36,22,0.15);
    border-radius: 6px;
    pointer-events: none;
  }

  @keyframes cardFlip {
    from { transform: rotateY(90deg) scale(0.8); opacity: 0; }
    to { transform: rotateY(0deg) scale(1); opacity: 1; }
  }

  .drawn-by { font-size: 0.8rem; color: var(--muted); font-style: italic; }

  .player-panel {
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.15);
    border-radius: 10px;
    padding: 16px;
    min-height: 200px;
  }

  .player-panel h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(201,168,76,0.15);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .player-dot-lg {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .hand-cards { display: flex; flex-direction: column; gap: 6px; }

  .hand-card {
    background: rgba(245,240,232,0.06);
    border: 1px solid rgba(200,184,154,0.15);
    border-radius: 6px;
    padding: 7px 10px;
    font-size: 0.88rem;
    color: rgba(245,240,232,0.75);
    font-style: italic;
    line-height: 1.3;
  }

  .hand-empty { color: var(--muted); font-style: italic; font-size: 0.85rem; }

  .all-players {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
  }

  .status-bar {
    text-align: center;
    color: var(--muted);
    font-style: italic;
    font-size: 0.9rem;
    margin-top: 8px;
    min-height: 1.2em;
  }

  .highlight { color: var(--gold-light); }
  .btn-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

  /* ── SAVE/LOAD INDICATOR ──────────────────────────────────────────────── */
  .sync-indicator {
    position: fixed;
    bottom: 16px;
    right: 16px;
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 0.8rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .sync-indicator.visible { opacity: 1; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gold); }
  .sync-dot.saving { animation: pulse 0.6s ease-in-out infinite alternate; }
  .sync-dot.saved { background: #7ed4a0; }
  .sync-dot.error { background: #e07070; }
  @keyframes pulse { to { opacity: 0.3; } }

  /* ── CONFIRM OVERLAY ──────────────────────────────────────────────────── */
  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(3px);
  }

  .confirm-box {
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 12px;
    padding: 32px;
    text-align: center;
    max-width: 320px;
  }

  .confirm-box h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    color: var(--gold-light);
    margin-bottom: 10px;
  }

  .confirm-box p { color: var(--muted); margin-bottom: 24px; font-size: 0.95rem; }
  .confirm-btn-row { display: flex; gap: 12px; justify-content: center; }

  .btn-danger {
    background: #8b3a3a;
    color: #f5e8e8;
    border: none;
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    padding: 10px 22px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-danger:hover { background: #a84444; }

  .btn-ghost {
    background: none;
    border: 1px solid rgba(255,255,255,0.15);
    color: var(--muted);
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    padding: 10px 22px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-ghost:hover { border-color: rgba(255,255,255,0.3); color: var(--card-bg); }
</style>
</head>
<body>

<h1>The Deck</h1>
<p class="subtitle">A game of drawing & doing</p>

<!-- LOADING SCREEN — shown briefly while we check for a saved game -->
<div id="loading-screen">
  <div class="spinner"></div>
  <p class="loading-text">Checking for saved game…</p>
</div>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div class="setup-card">
    <h2>Who's playing?</h2>
    <div id="player-list">
      <div class="player-entry">
        <div class="player-dot" style="background:#7eb8d4"></div>
        <input type="text" placeholder="Player 1 name">
      </div>
      <div class="player-entry">
        <div class="player-dot" style="background:#d47e7e"></div>
        <input type="text" placeholder="Player 2 name">
      </div>
    </div>
    <button class="btn-add-player" id="btn-add-player" onclick="addPlayer()">+ Add another player</button>
  </div>
  <p class="error-msg" id="setup-error"></p>
  <button class="btn-primary" onclick="startGame()">Deal the Deck</button>
</div>

<!-- GAME SCREEN -->
<div id="game-screen">
  <div class="turn-banner">
    <div class="turn-label">Current Turn</div>
    <div class="turn-name" id="turn-name">—</div>
  </div>

  <div class="game-layout">
    <div id="left-panel" class="player-panel">
      <h3><span class="player-dot-lg" id="left-dot"></span><span id="left-name">Player</span></h3>
      <div class="hand-cards" id="left-hand"></div>
    </div>

    <div class="center-col">
      <div class="deck-area" id="deck-area" onclick="drawCard()">
        <div class="deck-shadow"></div>
        <div class="deck-card">
          <div class="deck-pattern">
            <span class="deck-count" id="deck-count">19</span>
          </div>
        </div>
      </div>
      <div class="deck-label">cards remaining</div>
      <div class="drawn-card-area" id="drawn-card-area">
        <div class="status-bar" id="status-bar">Click the deck to draw</div>
      </div>
      <div class="btn-row">
        <button class="btn-draw" id="btn-draw" onclick="drawCard()">Draw Card</button>
        <button class="btn-reshuffle" onclick="confirmReshuffle()">↺ Reshuffle</button>
      </div>
    </div>

    <div id="right-panel" class="player-panel">
      <h3><span class="player-dot-lg" id="right-dot"></span><span id="right-name">Player</span></h3>
      <div class="hand-cards" id="right-hand"></div>
    </div>
  </div>

  <div class="all-players" id="extra-players"></div>
</div>

<!-- Confirm reshuffle overlay -->
<div class="confirm-overlay" id="confirm-overlay" style="display:none">
  <div class="confirm-box">
    <h3>Reshuffle the Deck?</h3>
    <p>All cards will be returned and the deck shuffled. Everyone's hand will be cleared.</p>
    <div class="confirm-btn-row">
      <button class="btn-ghost" onclick="closeConfirm()">Cancel</button>
      <button class="btn-danger" onclick="reshuffle()">Yes, Reshuffle</button>
    </div>
  </div>
</div>

<!-- Sync indicator — bottom right corner -->
<div class="sync-indicator" id="sync-indicator">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-text">Saving…</span>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// SUPABASE CONFIGURATION
// These keys connect us to your Supabase project.
// The anon key is safe to be here — RLS policies protect the data.
// ═══════════════════════════════════════════════════════════════════════════
const SUPABASE_URL = 'https://ffztxyeevdqlhvxzcopn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmenR4eWVldmRxbGh2eHpjb3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNzgxMTMsImV4cCI6MjA4Nzg1NDExM30.EdA8cwETE00YFENj-CN93ScKMFN4yfNNG63BentHiQ4';

// Initialise the Supabase client — this is our connection to the database
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ═══════════════════════════════════════════════════════════════════════════
// CARD DATA — your 19 cards
// ═══════════════════════════════════════════════════════════════════════════
const CARD_TEXTS = [
  "Nothing",
  "No target",
  "Miss",
  "Relocate",
  "Nothing there",
  "Grenade: relocate in 2 or explode",
  "Bandage",
  "High Ground: Spotting 8+(D12)",
  "Counter Snipe: 4+(D6)",
  "Snipers relocate",
  "Missed shot",
  "Hit",
  "Hit the target",
  "No thing",
  "Not a target",
  "Found him: Body",
  "Found him: Head",
  "Decoy",
  "Decoy deployed",
];

const COLORS = ['#7eb8d4','#d47e7e','#7ed4a0','#d4c07e','#c47ed4','#d4a07e'];

// ═══════════════════════════════════════════════════════════════════════════
// LOCAL GAME STATE
// These variables mirror what's in the database.
// ═══════════════════════════════════════════════════════════════════════════
let players = [];       // Array of { name, color }
let deck = [];          // Array of card strings (remaining cards)
let hands = {};         // { playerName: [card, card, ...] }
let currentPlayerIndex = 0;
let lastDrawn = null;   // { card, playerName }
let currentGameId = null; // The UUID of the current game row in Supabase
let isSaving = false;   // Prevents overlapping save operations

// ═══════════════════════════════════════════════════════════════════════════
// STARTUP — check if a game was saved in this browser session
// We store the game ID in sessionStorage so refreshing the page reloads it.
// (sessionStorage clears when the browser tab is closed)
// ═══════════════════════════════════════════════════════════════════════════
async function init() {
  const savedId = sessionStorage.getItem('deck_game_id');

  if (savedId) {
    // Try to load the saved game from Supabase
    const loaded = await loadGame(savedId);
    if (loaded) return; // Successfully restored — go straight to game screen
  }

  // No saved game found — show setup screen
  show('setup-screen');
  hide('loading-screen');
}

// ═══════════════════════════════════════════════════════════════════════════
// SETUP
// ═══════════════════════════════════════════════════════════════════════════
function addPlayer() {
  const list = document.getElementById('player-list');
  const count = list.children.length + 1;
  if (count > 6) return;
  const color = COLORS[count - 1] || '#aaa';
  const div = document.createElement('div');
  div.className = 'player-entry';
  div.innerHTML = `
    <div class="player-dot" style="background:${color}"></div>
    <input type="text" placeholder="Player ${count} name">
  `;
  list.appendChild(div);
  if (count >= 6) document.getElementById('btn-add-player').style.display = 'none';
}

async function startGame() {
  const inputs = document.querySelectorAll('#player-list input');
  players = [];
  inputs.forEach((inp, i) => {
    const name = inp.value.trim() || `Player ${i + 1}`;
    players.push({ name, color: COLORS[i] });
  });

  // Build initial state
  hands = {};
  players.forEach(p => hands[p.name] = []);
  currentPlayerIndex = 0;
  lastDrawn = null;
  deck = shuffle([...CARD_TEXTS]);

  // Disable button while saving
  const btn = document.querySelector('.btn-primary');
  btn.disabled = true;
  btn.textContent = 'Saving…';

  // Save to Supabase and get back a game ID
  const saved = await saveNewGame();

  if (!saved) {
    document.getElementById('setup-error').textContent = 'Could not connect to database. Check your internet connection.';
    btn.disabled = false;
    btn.textContent = 'Deal the Deck';
    return;
  }

  show('game-screen');
  hide('setup-screen');
  renderPlayerPanels();
  updateUI();
}

// ═══════════════════════════════════════════════════════════════════════════
// GAME LOGIC
// ═══════════════════════════════════════════════════════════════════════════
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

async function drawCard() {
  if (deck.length === 0 || isSaving) return;

  const card = deck.pop();
  const player = players[currentPlayerIndex];
  hands[player.name].push(card);
  lastDrawn = { card, playerName: player.name };
  currentPlayerIndex = (currentPlayerIndex + 1) % players.length;

  updateUI();

  // Save updated state to Supabase
  await saveGameState();

  // Log the draw event (for the event history / rejoin feature later)
  await logEvent('draw', card);
}

async function reshuffle() {
  closeConfirm();
  deck = shuffle([...CARD_TEXTS]);
  players.forEach(p => hands[p.name] = []);
  lastDrawn = null;
  currentPlayerIndex = 0;

  updateUI();
  renderHandsOnly();

  await saveGameState();
  await logEvent('reshuffle', null);
}

// ═══════════════════════════════════════════════════════════════════════════
// SUPABASE — DATABASE OPERATIONS
// These functions talk to your Supabase database.
// ═══════════════════════════════════════════════════════════════════════════

// Creates a brand new game row in the database
async function saveNewGame() {
  try {
    showSyncing('Saving…');

    // Generate a short human-readable join code (for future use)
    const joinCode = generateJoinCode();

    // Build the full game state object to store
    const gameState = buildGameState();

    const { data, error } = await db
      .from('games')
      .insert({
        join_code: joinCode,
        deck: gameState,           // stores everything as JSON
        current_player_index: currentPlayerIndex,
        status: 'active'
      })
      .select()
      .single();

    if (error) {
      console.error('Save error:', error);
      showSyncError();
      return false;
    }

    // Store the game ID so we can update this row later
    currentGameId = data.id;
    sessionStorage.setItem('deck_game_id', currentGameId);

    showSynced();
    return true;

  } catch (err) {
    console.error('Save error:', err);
    showSyncError();
    return false;
  }
}

// Updates the existing game row with current state
async function saveGameState() {
  if (!currentGameId || isSaving) return;

  try {
    isSaving = true;
    showSyncing('Saving…');

    const { error } = await db
      .from('games')
      .update({
        deck: buildGameState(),
        current_player_index: currentPlayerIndex,
      })
      .eq('id', currentGameId);

    if (error) {
      console.error('Update error:', error);
      showSyncError();
    } else {
      showSynced();
    }

  } catch (err) {
    console.error('Update error:', err);
    showSyncError();
  } finally {
    isSaving = false;
  }
}

// Loads a saved game from Supabase by its ID
async function loadGame(gameId) {
  try {
    const { data, error } = await db
      .from('games')
      .select('*')
      .eq('id', gameId)
      .eq('status', 'active')
      .single();

    if (error || !data) {
      // Game not found or finished — clear saved ID
      sessionStorage.removeItem('deck_game_id');
      return false;
    }

    // Restore state from the saved JSON
    const state = data.deck; // our JSON blob
    players = state.players;
    deck = state.deck;
    hands = state.hands;
    lastDrawn = state.lastDrawn;
    currentPlayerIndex = data.current_player_index;
    currentGameId = data.id;

    hide('loading-screen');
    show('game-screen');
    renderPlayerPanels();
    updateUI();
    return true;

  } catch (err) {
    console.error('Load error:', err);
    sessionStorage.removeItem('deck_game_id');
    return false;
  }
}

// Logs a draw or reshuffle event to the game_events table
async function logEvent(eventType, cardText) {
  if (!currentGameId) return;
  try {
    await db.from('game_events').insert({
      game_id: currentGameId,
      profile_id: null,         // null for now — will be real user ID in Stage 2
      event_type: eventType,
      card_text: cardText,
    });
  } catch (err) {
    // Event logging failure is non-critical — don't block gameplay
    console.warn('Event log failed:', err);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════════════════

// Packages the full game state into a single JSON object for storage
function buildGameState() {
  return {
    players,
    deck,
    hands,
    lastDrawn,
  };
}

// Generates a short readable join code like "WOLF-4" (used in Stage 3)
function generateJoinCode() {
  const words = ['WOLF','HAWK','VIPER','ECHO','GHOST','RAVEN','COBRA','LYNX'];
  const word = words[Math.floor(Math.random() * words.length)];
  const num = Math.floor(Math.random() * 9) + 1;
  return `${word}-${num}`;
}

// ═══════════════════════════════════════════════════════════════════════════
// SYNC INDICATOR — the small saving/saved notice in the corner
// ═══════════════════════════════════════════════════════════════════════════
let syncTimer = null;

function showSyncing(text) {
  clearTimeout(syncTimer);
  const indicator = document.getElementById('sync-indicator');
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-text');
  dot.className = 'sync-dot saving';
  label.textContent = text;
  indicator.classList.add('visible');
}

function showSynced() {
  const indicator = document.getElementById('sync-indicator');
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-text');
  dot.className = 'sync-dot saved';
  label.textContent = 'Saved';
  syncTimer = setTimeout(() => indicator.classList.remove('visible'), 2000);
}

function showSyncError() {
  const indicator = document.getElementById('sync-indicator');
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-text');
  dot.className = 'sync-dot error';
  label.textContent = 'Save failed';
  syncTimer = setTimeout(() => indicator.classList.remove('visible'), 3000);
}

// ═══════════════════════════════════════════════════════════════════════════
// RENDER — unchanged from original, just separated cleanly
// ═══════════════════════════════════════════════════════════════════════════
function renderPlayerPanels() {
  document.getElementById('left-dot').style.background = players[0].color;
  document.getElementById('left-name').textContent = players[0].name;

  const rightPlayer = players[1] || players[0];
  document.getElementById('right-dot').style.background = rightPlayer.color;
  document.getElementById('right-name').textContent = rightPlayer.name;

  const extra = document.getElementById('extra-players');
  extra.innerHTML = '';
  players.slice(2).forEach((p, i) => {
    const panel = document.createElement('div');
    panel.className = 'player-panel';
    panel.innerHTML = `
      <h3><span class="player-dot-lg" style="background:${p.color}"></span>${p.name}</h3>
      <div class="hand-cards" id="extra-hand-${i}"></div>
    `;
    extra.appendChild(panel);
  });
}

function renderHandsOnly() {
  renderHand('left-hand', players[0].name);
  if (players[1]) renderHand('right-hand', players[1].name);
  players.slice(2).forEach((p, i) => renderHand(`extra-hand-${i}`, p.name));
}

function renderHand(containerId, playerName) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const cards = hands[playerName] || [];
  if (cards.length === 0) {
    el.innerHTML = '<div class="hand-empty">No cards yet</div>';
  } else {
    el.innerHTML = cards.map(c => `<div class="hand-card">${c}</div>`).join('');
  }
}

function updateUI() {
  const remaining = deck.length;
  document.getElementById('deck-count').textContent = remaining;
  const deckArea = document.getElementById('deck-area');
  deckArea.classList.toggle('empty', remaining === 0);
  document.getElementById('btn-draw').disabled = remaining === 0;

  const current = players[currentPlayerIndex];
  const turnEl = document.getElementById('turn-name');
  turnEl.textContent = current.name;
  turnEl.style.color = current.color;

  const drawnArea = document.getElementById('drawn-card-area');

  if (lastDrawn) {
    drawnArea.innerHTML = `
      <div class="drawn-card">${lastDrawn.card}</div>
      <div class="drawn-by">Drawn by ${lastDrawn.playerName}</div>
    `;
  } else if (remaining === 0) {
    drawnArea.innerHTML = `<div class="status-bar"><span class="highlight">Deck is empty — reshuffle to play again!</span></div>`;
  } else {
    drawnArea.innerHTML = `<div class="status-bar">Click the deck to draw</div>`;
  }

  renderHandsOnly();
}

function confirmReshuffle() { document.getElementById('confirm-overlay').style.display = 'flex'; }
function closeConfirm() { document.getElementById('confirm-overlay').style.display = 'none'; }

document.getElementById('confirm-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});

function show(id) { document.getElementById(id).style.display = 'flex'; }
function hide(id) { document.getElementById(id).style.display = 'none'; }

// ═══════════════════════════════════════════════════════════════════════════
// START
// ═══════════════════════════════════════════════════════════════════════════
init();
</script>
</body>
</html>
